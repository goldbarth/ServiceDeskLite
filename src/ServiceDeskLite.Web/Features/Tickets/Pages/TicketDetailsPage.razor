@page "/tickets/{Id:guid}"
@using MudBlazor

<PageTitle>Ticket Details</PageTitle>

@if (_isLoading)
{
    <MudProgressLinear Indeterminate="true" />
}
else if (_error is not null)
{
    <AppErrorPanel Error="_error" />
}
else if (_ticket is null)
{
    <MudText>Ticket not found.</MudText>
}
else
{
    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h5">@_ticket.Title</MudText>

        <MudText>Status: @_ticket.Status</MudText>
        <MudText>Priority: @_ticket.Priority</MudText>
        <MudText>Created: @_ticket.CreatedAt.ToString("u")</MudText>
        <MudText>
            Due:
            @(_ticket.DueAt is null ? "-" : _ticket.DueAt.Value.ToString("u"))
        </MudText>

        @{
            var allowedTransitions = StatusTransitionHelper.GetAllowedTransitions(_ticket.Status);
        }
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4"
                   OnClick="OpenChangeStatusDialogAsync"
                   Disabled="@(allowedTransitions.Count == 0)">
            Change Status
        </MudButton>
    </MudPaper>
}

@code {
    [Inject] ITicketsApiClient TicketsApi { get; set; } = default!;
    [Inject] IDialogService DialogService { get; set; } = default!;
    [Inject] ISnackbar Snackbar { get; set; } = default!;

    [Parameter] public Guid Id { get; set; }

    private bool _isLoading;
    private ApiError? _error;
    private TicketResponse? _ticket;

    protected override async Task OnParametersSetAsync()
    {
        _isLoading = true;
        _error = null;
        _ticket = null;

        var result = await TicketsApi.GetByIdAsync(Id);

        if (result.IsSuccess)
            _ticket = result.Value;
        else
            _error = result.Error;

        _isLoading = false;
    }

    private async Task OpenChangeStatusDialogAsync()
    {
        var parameters = new DialogParameters<ChangeStatusDialog>
        {
            { x => x.TicketId, _ticket!.Id },
            { x => x.CurrentStatus, _ticket!.Status }
        };

        var dialog = await DialogService.ShowAsync<ChangeStatusDialog>(
            "Change Ticket Status", parameters);

        var result = await dialog.Result;

        if (result is { Canceled: false, Data: TicketResponse updated })
        {
            _ticket = updated;
            Snackbar.Add("Status updated.", Severity.Success);
        }
    }
}
